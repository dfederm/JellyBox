<Page
    x:Class="JellyBox.Views.ItemDetails"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:Jellyfin.Sdk.Generated.Models"
    xmlns:local="using:JellyBox.Views"
    xmlns:ViewModels="using:JellyBox.ViewModels"
    xmlns:Interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:Behaviors="using:JellyBox.Behaviors"
    xmlns:uc="using:JellyBox.Controls"
    xmlns:m="using:JellyBox.Models"
    xmlns:g="using:JellyBox"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{StaticResource BackgroundBase}">
    <Grid XYFocusKeyboardNavigation="Enabled">
        <!-- Full-screen Backdrop -->
        <Grid.Background>
            <ImageBrush
                AlignmentX="Center"
                AlignmentY="Top"
                Stretch="UniformToFill"
                Opacity="0.35">
                <ImageBrush.ImageSource>
                    <BitmapImage UriSource="{x:Bind ViewModel.BackdropImageUri, Mode=OneWay, FallbackValue=null}" />
                </ImageBrush.ImageSource>
            </ImageBrush>
        </Grid.Background>
        
        <!-- Gradient overlays for readability -->
        <Rectangle>
            <Rectangle.Fill>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#000A0A0A" Offset="0.0" />
                    <GradientStop Color="#800A0A0A" Offset="0.3" />
                    <GradientStop Color="#FF0A0A0A" Offset="0.75" />
                </LinearGradientBrush>
            </Rectangle.Fill>
        </Rectangle>
        <Rectangle>
            <Rectangle.Fill>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                    <GradientStop Color="#CC0A0A0A" Offset="0.0" />
                    <GradientStop Color="#000A0A0A" Offset="0.6" />
                </LinearGradientBrush>
            </Rectangle.Fill>
        </Rectangle>
        
        <!-- Top gradient overlay for fade effect -->
        <Grid Height="80" VerticalAlignment="Top" Canvas.ZIndex="10" IsHitTestVisible="False">
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#CC0A0A0A" Offset="0.0" />
                    <GradientStop Color="#000A0A0A" Offset="1.0" />
                </LinearGradientBrush>
            </Grid.Background>
        </Grid>
        
        <!-- Main Content -->
        <ScrollViewer
            x:Name="ContentScrollViewer"
            VerticalScrollBarVisibility="Hidden"
            BringIntoViewOnFocusChange="False"
            IsTabStop="False">
            <Grid x:Name="ContentGrid" XYFocusKeyboardNavigation="Enabled" Margin="48,100,48,48">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="380" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                
                <!-- Poster Image -->
                <Border Grid.Column="0" Grid.Row="0"
                        CornerRadius="{StaticResource CardCornerRadius}"
                        Margin="0,0,40,0"
                        VerticalAlignment="Top">
                    <uc:LazyLoadedImage
                        ImageUri="{x:Bind ViewModel.PrimaryImage.Uri, Mode=OneWay}"
                        BlurHash="{x:Bind ViewModel.PrimaryImage.BlurHash, Mode=OneWay}"
                        Width="340"
                        Height="510" />
                </Border>
                
                <!-- Content Info -->
                <StackPanel x:Name="ContentInfoPanel" Grid.Column="1" Grid.Row="0" MaxWidth="800" HorizontalAlignment="Left" XYFocusKeyboardNavigation="Enabled">
                    
                    <!-- Logo or Title -->
                    <Image 
                        MaxWidth="400"
                        MaxHeight="120"
                        HorizontalAlignment="Left"
                        Margin="0,0,0,16"
                        Visibility="{x:Bind ViewModel.LogoImageUri, Mode=OneWay, Converter={StaticResource VisibleIfNotNullConverter}}">
                        <Image.Source>
                            <BitmapImage UriSource="{x:Bind ViewModel.LogoImageUri, Mode=OneWay}" />
                        </Image.Source>
                    </Image>
                    
                    <TextBlock
                        Text="{x:Bind ViewModel.Name, Mode=OneWay}"
                        FontSize="{StaticResource FontXXL}"
                        FontWeight="Bold"
                        Foreground="{StaticResource TextPrimary}"
                        TextWrapping="Wrap"
                        MaxLines="2" />
                    
                    <!-- Media Info (Year, Rating, Duration) -->
                    <ListView
                        ItemsSource="{x:Bind ViewModel.MediaInfo, Mode=OneWay}"
                        SelectionMode="None"
                        Margin="0,12,0,0">
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="IsTabStop" Value="False"/>
                                <Setter Property="Padding" Value="0,0,24,0" />
                                <Setter Property="MinWidth" Value="0" />
                                <Setter Property="MinHeight" Value="0" />
                            </Style>
                        </ListView.ItemContainerStyle>
                        <ListView.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsStackPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ListView.ItemsPanel>
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="ViewModels:MediaInfoItem">
                                <TextBlock
                                    Text="{x:Bind Text}"
                                    FontSize="{StaticResource FontM}"
                                    Foreground="{StaticResource TextMuted}" />
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                    
                    <!-- Tagline -->
                    <TextBlock
                        Text="{x:Bind ViewModel.TagLine, Mode=OneWay}"
                        FontSize="{StaticResource FontL}"
                        FontStyle="Italic"
                        Foreground="{StaticResource TextSecondary}"
                        TextWrapping="Wrap"
                        Margin="0,20,0,0"
                        Visibility="{x:Bind ViewModel.TagLine, Mode=OneWay, Converter={StaticResource VisibleIfNotNullConverter}}" />
                    
                    <!-- Overview -->
                    <TextBlock
                        Text="{x:Bind ViewModel.Overview, Mode=OneWay}"
                        FontSize="{StaticResource FontS}"
                        Foreground="{StaticResource TextSecondary}"
                        TextWrapping="Wrap"
                        MaxLines="4"
                        Margin="0,16,0,0" />
                    
                    <!-- Action Buttons -->
                    <StackPanel 
                        Orientation="Horizontal" 
                        Margin="0,32,0,0"
                        Spacing="16"
                        XYFocusKeyboardNavigation="Enabled">
                        <Button
                            x:Name="PlayButton"
                            Style="{StaticResource PrimaryButton}"
                            Click="{x:Bind ViewModel.Play}"
                            Visibility="{x:Bind ViewModel.CanPlay, Mode=OneWay}"
                            XYFocusLeft="{x:Bind PlayButton}">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <FontIcon Glyph="&#xE768;" FontSize="20" />
                                <TextBlock Text="Play" />
                            </StackPanel>
                        </Button>
                        <Button
                            x:Name="TrailerButton"
                            Style="{StaticResource SecondaryButton}"
                            Click="{x:Bind ViewModel.PlayTrailer}"
                            Visibility="{x:Bind ViewModel.HasTrailer, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <FontIcon Glyph="&#xE714;" FontSize="20" />
                                <TextBlock Text="Trailer" />
                            </StackPanel>
                        </Button>
                        <Button
                            x:Name="PlayedButton"
                            Style="{StaticResource IconButton}"
                            Click="{x:Bind ViewModel.TogglePlayed}"
                            Visibility="{x:Bind ViewModel.CanMarkPlayed, Mode=OneWay}">
                            <FontIcon
                                Glyph="{x:Bind g:Glyphs.Accept}"
                                FontFamily="{StaticResource SegoeIcons}"
                                Foreground="{x:Bind ViewModel.IsPlayed, Mode=OneWay, Converter={StaticResource BoolToBrushConverter}}" />
                        </Button>
                        <Button
                            x:Name="FavoriteButton"
                            Style="{StaticResource IconButton}"
                            Click="{x:Bind ViewModel.ToggleFavorite}"
                            Visibility="{x:Bind ViewModel.CanMarkFavorite, Mode=OneWay}"
                            XYFocusRight="{x:Bind FavoriteButton}">
                            <FontIcon
                                Glyph="{x:Bind g:Glyphs.HeartFilled}"
                                FontFamily="{StaticResource SegoeIcons}"
                                Foreground="{x:Bind ViewModel.IsFavorite, Mode=OneWay, Converter={StaticResource BoolToBrushConverter}}" />
                        </Button>
                    </StackPanel>
                    
                    <!-- Stream Selection (if applicable) -->
                    <StackPanel
                        Margin="0,32,0,0"
                        Spacing="12"
                        XYFocusKeyboardNavigation="Enabled"
                        Visibility="{x:Bind ViewModel.SourceContainers, Mode=OneWay, Converter={StaticResource VisibleIfNotNullConverter}}">
                        
                        <!-- Version Selection - Button when multiple, Text when single -->
                        <Button
                            x:Name="VersionButton"
                            Style="{StaticResource SecondaryButton}"
                            MinWidth="320"
                            HorizontalAlignment="Left"
                            HorizontalContentAlignment="Left"
                            XYFocusLeft="{x:Bind VersionButton}"
                            XYFocusRight="{x:Bind VersionButton}"
                            Visibility="{x:Bind ViewModel.HasMultipleSources, Mode=OneWay}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock
                                    Text="Version"
                                    Foreground="{StaticResource TextMuted}"
                                    VerticalAlignment="Center" />
                                <TextBlock
                                    Grid.Column="1"
                                    Text="{x:Bind ViewModel.SelectedSourceContainer.Value.Name, Mode=OneWay}"
                                    VerticalAlignment="Center" />
                                <FontIcon
                                    Grid.Column="2"
                                    Glyph="&#xE70D;"
                                    FontSize="12"
                                    Foreground="{StaticResource TextMuted}" />
                            </Grid>
                            <Button.Flyout>
                                <MenuFlyout
                                    x:Name="VersionFlyout"
                                    Placement="BottomEdgeAlignedLeft">
                                    <MenuFlyout.MenuFlyoutPresenterStyle>
                                        <Style TargetType="MenuFlyoutPresenter">
                                            <Setter Property="Background" Value="{StaticResource BackgroundCard}" />
                                            <Setter Property="BorderBrush" Value="{StaticResource BorderDefault}" />
                                        </Style>
                                    </MenuFlyout.MenuFlyoutPresenterStyle>
                                </MenuFlyout>
                            </Button.Flyout>
                        </Button>
                        <Grid
                            MinWidth="320"
                            Visibility="{x:Bind ViewModel.HasSingleSource, Mode=OneWay}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock
                                Text="Version"
                                Foreground="{StaticResource TextMuted}"
                                VerticalAlignment="Center"
                                FontSize="{StaticResource FontS}" />
                            <TextBlock
                                Grid.Column="1"
                                Text="{x:Bind ViewModel.SelectedSourceContainer.Value.Name, Mode=OneWay}"
                                Foreground="{StaticResource TextPrimary}"
                                FontSize="{StaticResource FontS}" />
                        </Grid>
                        
                        <!-- Audio Selection - Button when multiple, Text when single -->
                        <Button
                            x:Name="AudioButton"
                            Style="{StaticResource SecondaryButton}"
                            MinWidth="320"
                            HorizontalAlignment="Left"
                            HorizontalContentAlignment="Left"
                            XYFocusLeft="{x:Bind AudioButton}"
                            XYFocusRight="{x:Bind AudioButton}"
                            Visibility="{x:Bind ViewModel.HasMultipleAudioStreams, Mode=OneWay}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock
                                    Text="Audio"
                                    Foreground="{StaticResource TextMuted}"
                                    VerticalAlignment="Center" />
                                <TextBlock
                                    Grid.Column="1"
                                    Text="{x:Bind ViewModel.SelectedAudioStream.DisplayText, Mode=OneWay}"
                                    VerticalAlignment="Center" />
                                <FontIcon
                                    Grid.Column="2"
                                    Glyph="&#xE70D;"
                                    FontSize="12"
                                    Foreground="{StaticResource TextMuted}" />
                            </Grid>
                            <Button.Flyout>
                                <MenuFlyout
                                    x:Name="AudioFlyout"
                                    Placement="BottomEdgeAlignedLeft">
                                    <MenuFlyout.MenuFlyoutPresenterStyle>
                                        <Style TargetType="MenuFlyoutPresenter">
                                            <Setter Property="Background" Value="{StaticResource BackgroundCard}" />
                                            <Setter Property="BorderBrush" Value="{StaticResource BorderDefault}" />
                                        </Style>
                                    </MenuFlyout.MenuFlyoutPresenterStyle>
                                </MenuFlyout>
                            </Button.Flyout>
                        </Button>
                        <Grid
                            MinWidth="320"
                            Visibility="{x:Bind ViewModel.HasSingleAudioStream, Mode=OneWay}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock
                                Text="Audio"
                                Foreground="{StaticResource TextMuted}"
                                VerticalAlignment="Center"
                                FontSize="{StaticResource FontS}" />
                            <TextBlock
                                Grid.Column="1"
                                Text="{x:Bind ViewModel.SelectedAudioStream.DisplayText, Mode=OneWay}"
                                Foreground="{StaticResource TextPrimary}"
                                FontSize="{StaticResource FontS}" />
                        </Grid>
                        
                        <!-- Subtitle Selection - Button when multiple, Text when single -->
                        <Button
                            x:Name="SubtitleButton"
                            Style="{StaticResource SecondaryButton}"
                            MinWidth="320"
                            HorizontalAlignment="Left"
                            HorizontalContentAlignment="Left"
                            XYFocusLeft="{x:Bind SubtitleButton}"
                            XYFocusRight="{x:Bind SubtitleButton}"
                            Visibility="{x:Bind ViewModel.HasMultipleSubtitleStreams, Mode=OneWay}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock
                                    Text="Subtitles"
                                    Foreground="{StaticResource TextMuted}"
                                    VerticalAlignment="Center" />
                                <TextBlock
                                    Grid.Column="1"
                                    Text="{x:Bind ViewModel.SelectedSubtitleStream.DisplayText, Mode=OneWay}"
                                    VerticalAlignment="Center" />
                                <FontIcon
                                    Grid.Column="2"
                                    Glyph="&#xE70D;"
                                    FontSize="12"
                                    Foreground="{StaticResource TextMuted}" />
                            </Grid>
                            <Button.Flyout>
                                <MenuFlyout
                                    x:Name="SubtitleFlyout"
                                    Placement="BottomEdgeAlignedLeft">
                                    <MenuFlyout.MenuFlyoutPresenterStyle>
                                        <Style TargetType="MenuFlyoutPresenter">
                                            <Setter Property="Background" Value="{StaticResource BackgroundCard}" />
                                            <Setter Property="BorderBrush" Value="{StaticResource BorderDefault}" />
                                        </Style>
                                    </MenuFlyout.MenuFlyoutPresenterStyle>
                                </MenuFlyout>
                            </Button.Flyout>
                        </Button>
                        <Grid
                            MinWidth="320"
                            Visibility="{x:Bind ViewModel.HasSingleSubtitleStream, Mode=OneWay}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock
                                Text="Subtitles"
                                Foreground="{StaticResource TextMuted}"
                                VerticalAlignment="Center"
                                FontSize="{StaticResource FontS}" />
                            <TextBlock
                                Grid.Column="1"
                                Text="{x:Bind ViewModel.SelectedSubtitleStream.DisplayText, Mode=OneWay}"
                                Foreground="{StaticResource TextPrimary}"
                                FontSize="{StaticResource FontS}" />
                        </Grid>
                    </StackPanel>
                    
                    <!-- Tags -->
                    <TextBlock
                        Text="{x:Bind ViewModel.Tags, Mode=OneWay}"
                        FontSize="{StaticResource FontXS}"
                        Foreground="{StaticResource TextMuted}"
                        TextWrapping="Wrap"
                        Margin="0,24,0,0"
                        Visibility="{x:Bind ViewModel.Tags, Mode=OneWay, Converter={StaticResource VisibleIfNotNullConverter}}" />
                </StackPanel>
                
                <!-- Related Content Sections -->
                <StackPanel Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1" Margin="-48,40,-48,0" XYFocusKeyboardNavigation="Enabled">
                    <ItemsControl
                        x:Name="SectionsControl"
                        ItemsSource="{x:Bind ViewModel.Sections, Mode=OneWay}"
                        ItemTemplate="{StaticResource Section}"
                        XYFocusKeyboardNavigation="Enabled">
                        <Interactivity:Interaction.Behaviors>
                            <Behaviors:SectionNavigationBehavior
                                ScrollViewer="{x:Bind ContentScrollViewer}"
                                TrapAtTop="False"
                                TrapAtBottom="True" />
                        </Interactivity:Interaction.Behaviors>
                    </ItemsControl>
                </StackPanel>
            </Grid>
        </ScrollViewer>
    </Grid>
</Page>


